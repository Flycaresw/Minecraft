import os
import requests
import time
import subprocess

# Configuración
MINECRAFT_VERSION = "1.16.5"  # Cambia a la versión de Minecraft que deseas usar
FORGE_VERSION = "36.2.0"      # Cambia a la versión de Forge compatible con la versión de Minecraft
SERVER_DIRECTORY = "./minecraft_server"
FORGE_INSTALLER_URL = f"https://maven.minecraftforge.net/net/minecraftforge/forge/{MINECRAFT_VERSION}-{FORGE_VERSION}/forge-{MINECRAFT_VERSION}-{FORGE_VERSION}-installer.jar"
NGROK_TOKEN = "TU_NGROK_TOKEN_AQUI"  # Coloca tu token de autenticación de ngrok

def download_file(url, path):
    """Descarga un archivo desde una URL y lo guarda en una ruta específica."""
    print(f"Descargando {url}...")
    response = requests.get(url, stream=True)
    with open(path, "wb") as file:
        for chunk in response.iter_content(chunk_size=8192):
            if chunk:
                file.write(chunk)
    print(f"Archivo guardado en {path}")

def setup_forge_server():
    """Configura el servidor de Minecraft con Forge."""
    if not os.path.exists(SERVER_DIRECTORY):
        os.makedirs(SERVER_DIRECTORY)
    
    forge_installer_path = os.path.join(SERVER_DIRECTORY, "forge_installer.jar")
    
    # Descargar el instalador de Forge
    download_file(FORGE_INSTALLER_URL, forge_installer_path)
    
    # Ejecutar el instalador de Forge
    print("Instalando Forge...")
    subprocess.run(["java", "-jar", forge_installer_path, "--installServer"], cwd=SERVER_DIRECTORY)
    print("Forge instalado correctamente.")
    
    # Aceptar el EULA
    with open(os.path.join(SERVER_DIRECTORY, "eula.txt"), "w") as eula_file:
        eula_file.write("eula=true\n")
    
    # Eliminar el instalador para ahorrar espacio
    os.remove(forge_installer_path)

def start_server():
    """Inicia el servidor de Minecraft con Forge usando 10 GB de RAM."""
    server_jar = None
    for file in os.listdir(SERVER_DIRECTORY):
        if file.startswith("forge") and file.endswith(".jar"):
            server_jar = file
            break
    
    if server_jar:
        print("Iniciando el servidor de Minecraft con Forge con 10 GB de RAM...")
        subprocess.Popen(["java", "-Xmx10G", "-Xms10G", "-jar", server_jar, "nogui"], cwd=SERVER_DIRECTORY)
    else:
        print("Error: No se encontró el archivo del servidor Forge.")

def start_ngrok():
    """Inicia ngrok para exponer el servidor de Minecraft a una dirección IP pública."""
    # Autenticación en ngrok
    os.system(f"ngrok authtoken {NGROK_TOKEN}")
    # Iniciar ngrok en el puerto 25565 (el puerto por defecto de Minecraft)
    subprocess.Popen(["ngrok", "tcp", "25565"])

def main():
    print("Configurando servidor de Minecraft con Forge...")
    setup_forge_server()
    start_server()
    
    print("Exponiendo el servidor a Internet con ngrok...")
    start_ngrok()
    print("El servidor de Minecraft ahora debería estar accesible públicamente.")

if __name__ == "__main__":
    main()
